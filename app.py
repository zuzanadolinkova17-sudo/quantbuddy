# app.py ‚Äî QuantBuddy AI Asistent
# Inteligentn√≠ pr≈Øvodce kvantitativn√≠ anal√Ωzou pro studenty
# Spu≈°tƒõn√≠: streamlit run app.py

import io
import tempfile
from datetime import datetime
import numpy as np
import pandas as pd
import streamlit as st
import plotly.express as px
import plotly.graph_objects as go
from scipy import stats
import statsmodels.api as sm
from statsmodels.formula.api import ols
from docx import Document
from docx.shared import Inches, Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH

# ========================================
# KONFIGURACE
# ========================================

st.set_page_config(
    page_title="QuantBuddy AI ‚Äî Tv≈Øj statistick√Ω asistent",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ========================================
# CUSTOM CSS ‚Äî Modern√≠ design
# ========================================

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    
    * {
        font-family: 'Inter', sans-serif;
    }
    
    .main-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 3rem 2rem;
        border-radius: 20px;
        text-align: center;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }
    
    .main-header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin: 0;
    }
    
    .main-header p {
        font-size: 1.3rem;
        margin: 0.5rem 0 0 0;
        opacity: 0.95;
    }
    
    .step-card {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 2rem;
        border-radius: 15px;
        border-left: 5px solid #667eea;
        margin: 1.5rem 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .warning-box {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .success-box {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .result-card {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin: 1.5rem 0;
        border-top: 4px solid #667eea;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .stButton>button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        border: none;
        font-size: 1.1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .stButton>button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }
    
    .chat-bubble {
        background: #f5f5f5;
        padding: 1.5rem;
        border-radius: 15px;
        margin: 1rem 0;
        position: relative;
    }
    
    .chat-bubble::before {
        content: "ü§ñ";
        position: absolute;
        left: -40px;
        font-size: 2rem;
    }
    
    .progress-container {
        background: #f0f0f0;
        border-radius: 10px;
        padding: 0.5rem;
        margin: 2rem 0;
    }
    
    .tooltip-text {
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
    }
</style>
""", unsafe_allow_html=True)

# ========================================
# SESSION STATE
# ========================================

if 'step' not in st.session_state:
    st.session_state.step = 1
if 'df' not in st.session_state:
    st.session_state.df = None
if 'research_goal' not in st.session_state:
    st.session_state.research_goal = None
if 'recommended_analysis' not in st.session_state:
    st.session_state.recommended_analysis = None

# ========================================
# POMOCN√â FUNKCE
# ========================================

def detect_var_types(df: pd.DataFrame, cat_threshold: int = 10):
    """Inteligentn√≠ detekce typ≈Ø promƒõnn√Ωch."""
    types = {}
    descriptions = {}
    for col in df.columns:
        s = df[col]
        if pd.api.types.is_numeric_dtype(s):
            nunq = s.dropna().nunique()
            if nunq <= cat_threshold:
                types[col] = "kategorick√°"
                descriptions[col] = f"ƒå√≠seln√°, ale jen {nunq} r≈Øzn√Ωch hodnot ‚Üí pova≈æuji za kategorickou"
            else:
                types[col] = "numerick√°"
                descriptions[col] = f"ƒå√≠seln√° s {nunq} unik√°tn√≠mi hodnotami"
        else:
            types[col] = "kategorick√°"
            nunq = s.dropna().nunique()
            descriptions[col] = f"Textov√° s {nunq} kategoriemi"
    return types, descriptions

def recommend_analysis(df, types, goal):
    """AI doporuƒçen√≠ anal√Ωzy na z√°kladƒõ dat a c√≠le."""
    num_cols = [c for c, t in types.items() if t == "numerick√°"]
    cat_cols = [c for c, t in types.items() if t == "kategorick√°"]
    
    recommendations = []
    
    if goal == "vztah":
        if len(num_cols) >= 2:
            recommendations.append({
                "name": "Korelace (Pearsonova/Spearmanova)",
                "icon": "üîó",
                "reason": f"M√°≈° {len(num_cols)} numerick√Ωch promƒõnn√Ωch. Korelace uk√°≈æe, jak spolu souvis√≠.",
                "suitable_for": "Zji≈°tƒõn√≠ s√≠ly a smƒõru vztahu mezi dvƒõma ƒç√≠seln√Ωmi promƒõnn√Ωmi",
                "example": "Nap≈ô. vztah mezi studijn√≠m ƒçasem a zn√°mkami",
                "variables": {"x": num_cols, "y": num_cols},
                "type": "correlation"
            })
            recommendations.append({
                "name": "Line√°rn√≠ regrese",
                "icon": "üìà",
                "reason": "M≈Ø≈æe≈° p≈ôedpovƒõdƒõt jednu promƒõnnou z druh√©.",
                "suitable_for": "Predikce hodnoty jedn√© promƒõnn√© na z√°kladƒõ druh√©",
                "example": "Nap≈ô. p≈ôedpovƒõƒè zn√°mky podle studijn√≠ho ƒçasu",
                "variables": {"x": num_cols, "y": num_cols},
                "type": "regression"
            })
        if len(cat_cols) >= 2:
            recommendations.append({
                "name": "Ch√≠-kvadr√°t test",
                "icon": "üé≤",
                "reason": f"M√°≈° {len(cat_cols)} kategorick√Ωch promƒõnn√Ωch. Ch√≠-kvadr√°t uk√°≈æe, zda spolu souvis√≠.",
                "suitable_for": "Zji≈°tƒõn√≠ asociace mezi kategoriemi",
                "example": "Nap≈ô. souvislost mezi pohlav√≠m a oborem",
                "variables": {"var1": cat_cols, "var2": cat_cols},
                "type": "chi2"
            })
    
    elif goal == "porovn√°n√≠":
        if len(cat_cols) >= 1 and len(num_cols) >= 1:
            # Zkontroluj, jestli nƒõjak√° kategorick√° m√° p≈ôesnƒõ 2 √∫rovnƒõ
            two_level_cats = []
            for col in cat_cols:
                if df[col].nunique() == 2:
                    two_level_cats.append(col)
            
            if two_level_cats:
                recommendations.append({
                    "name": "T-test (porovn√°n√≠ 2 skupin)",
                    "icon": "‚öñÔ∏è",
                    "reason": f"M√°≈° kategorickou promƒõnnou se 2 skupinami a numerickou promƒõnnou.",
                    "suitable_for": "Porovn√°n√≠ pr≈Ømƒõr≈Ø mezi dvƒõma skupinami",
                    "example": "Nap≈ô. porovn√°n√≠ platu mu≈æ≈Ø vs. ≈æen",
                    "variables": {"group": two_level_cats, "outcome": num_cols},
                    "type": "ttest"
                })
            
            multi_level_cats = [c for c in cat_cols if df[c].nunique() > 2]
            if multi_level_cats:
                recommendations.append({
                    "name": "ANOVA (porovn√°n√≠ v√≠ce skupin)",
                    "icon": "üìä",
                    "reason": f"M√°≈° kategorickou promƒõnnou s v√≠ce ne≈æ 2 skupinami.",
                    "suitable_for": "Porovn√°n√≠ pr≈Ømƒõr≈Ø mezi 3+ skupinami",
                    "example": "Nap≈ô. porovn√°n√≠ plat≈Ø mezi obory",
                    "variables": {"group": multi_level_cats, "outcome": num_cols},
                    "type": "anova"
                })
    
    elif goal == "popis":
        recommendations.append({
            "name": "Deskriptivn√≠ statistika",
            "icon": "üìã",
            "reason": "Uk√°≈æu ti z√°kladn√≠ charakteristiky tv√Ωch dat.",
            "suitable_for": "Popis dat (pr≈Ømƒõr, medi√°n, rozptyl, ƒçetnosti)",
            "example": "Nap≈ô. pr≈Ømƒõrn√Ω vƒõk, nejƒçastƒõj≈°√≠ odpovƒõƒè",
            "variables": {"cols": list(df.columns)},
            "type": "descriptive"
        })
    
    if not recommendations:
        recommendations.append({
            "name": "Nejsem si jist√Ω",
            "icon": "ü§î",
            "reason": "Tvoje data nebo c√≠l nejsou jednoznaƒçn√©. Zkus mi ≈ô√≠ct v√≠c!",
            "suitable_for": "",
            "example": "",
            "variables": {},
            "type": None
        })
    
    return recommendations

def check_assumptions(df, analysis_type, var1, var2=None):
    """Kontrola statistick√Ωch p≈ôedpoklad≈Ø."""
    warnings = []
    tips = []
    
    if analysis_type in ["correlation", "regression", "ttest", "anova"]:
        # Kontrola velikosti vzorku
        n = len(df[[var1, var2]].dropna()) if var2 else len(df[var1].dropna())
        if n < 30:
            warnings.append(f"‚ö†Ô∏è M√°≈° jen {n} pozorov√°n√≠. Ide√°lnƒõ alespo≈à 30 pro spolehliv√© v√Ωsledky.")
        else:
            tips.append(f"‚úÖ Velikost vzorku ({n}) je v po≈ô√°dku!")
        
        # Kontrola normality pro numerick√© promƒõnn√©
        if analysis_type in ["correlation", "regression", "ttest"]:
            for var in [var1, var2] if var2 else [var1]:
                if pd.api.types.is_numeric_dtype(df[var]):
                    clean_data = df[var].dropna()
                    if len(clean_data) >= 3:
                        _, p = stats.shapiro(clean_data[:5000])  # Max 5000 pro Shapiro
                        if p < 0.05:
                            warnings.append(f"‚ö†Ô∏è Promƒõnn√° '{var}' nen√≠ norm√°lnƒõ rozlo≈æen√°. Zva≈æ Spearmanovu korelaci m√≠sto Pearsonovy.")
        
        # Kontrola chybƒõj√≠c√≠ch hodnot
        missing = df[[var1, var2]].isnull().sum().sum() if var2 else df[var1].isnull().sum()
        if missing > 0:
            warnings.append(f"‚ö†Ô∏è {missing} chybƒõj√≠c√≠ch hodnot bude vy≈ôazeno z anal√Ωzy.")
    
    return warnings, tips

# ========================================
# HLAVIƒåKA
# ========================================

st.markdown("""
<div class="main-header">
    <h1>ü§ñ QuantBuddy AI</h1>
    <p>Tv≈Øj inteligentn√≠ asistent pro kvantitativn√≠ anal√Ωzu</p>
    <p style="font-size: 1rem; margin-top: 1rem;">Nahraji data ‚Üí ≈òeknu ti c√≠l ‚Üí Dostanu hotov√© v√Ωsledky pro z√°vƒõreƒçnou pr√°ci ‚ú®</p>
</div>
""", unsafe_allow_html=True)

# Progress bar
progress = (st.session_state.step - 1) / 3
st.progress(progress)
col1, col2, col3 = st.columns(3)
with col1:
    st.markdown(f"**{'‚úÖ' if st.session_state.step > 1 else '1Ô∏è‚É£'} Krok 1: Data**")
with col2:
    st.markdown(f"**{'‚úÖ' if st.session_state.step > 2 else '2Ô∏è‚É£' if st.session_state.step == 2 else '‚ö™'} Krok 2: C√≠l**")
with col3:
    st.markdown(f"**{'‚úÖ' if st.session_state.step > 3 else '3Ô∏è‚É£' if st.session_state.step == 3 else '‚ö™'} Krok 3: Anal√Ωza**")

st.markdown("---")

# ========================================
# KROK 1: NAHR√ÅN√ç DAT
# ========================================

if st.session_state.step == 1:
    st.markdown('<div class="step-card">', unsafe_allow_html=True)
    st.markdown("## üìÇ Krok 1: Nahraj sv√° data")
    st.markdown("P≈ôet√°hni sem sv≈Øj Excel nebo CSV soubor. Pod√≠v√°m se na nƒõj a ≈ôeknu ti, co v nƒõm vid√≠m.")
    
    file = st.file_uploader("üìÅ Vyber soubor", type=["csv", "xlsx"], label_visibility="collapsed")
    
    if file:
        try:
            # Naƒçten√≠ souboru
            if file.name.lower().endswith(".xlsx"):
                xls = pd.ExcelFile(file)
                if len(xls.sheet_names) > 1:
                    sheet_name = st.selectbox("üìã Vyber list z Excelu:", xls.sheet_names)
                else:
                    sheet_name = xls.sheet_names[0]
                df = pd.read_excel(file, sheet_name=sheet_name, engine='openpyxl')
            else:
                try:
                    df = pd.read_csv(file, encoding='utf-8')
                except:
                    file.seek(0)
                    df = pd.read_csv(file, encoding='latin1', sep=';')
            
            st.session_state.df = df
            
            # Anal√Ωza dat
            types, descriptions = detect_var_types(df)
            
            st.markdown('<div class="success-box">', unsafe_allow_html=True)
            st.markdown(f"### ‚úÖ Super! Tv√° data jsou naƒçtena")
            st.markdown(f"**Poƒçet respondent≈Ø:** {df.shape[0]}")
            st.markdown(f"**Poƒçet promƒõnn√Ωch:** {df.shape[1]}")
            st.markdown('</div>', unsafe_allow_html=True)
            
            # N√°hled dat
            with st.expander("üëÄ Pod√≠vej se na data (prvn√≠ch 10 ≈ô√°dk≈Ø)"):
                st.dataframe(df.head(10), use_container_width=True)
            
            # Detekce typ≈Ø
            st.markdown("### üîç Co jsem v datech na≈°el:")
            
            col1, col2 = st.columns(2)
            with col1:
                st.markdown("**üìä Numerick√© promƒõnn√©** (ƒç√≠sla)")
                num_vars = [k for k, v in types.items() if v == "numerick√°"]
                if num_vars:
                    for var in num_vars:
                        st.markdown(f"- **{var}** ¬∑ {descriptions[var]}")
                else:
                    st.markdown("*≈Ω√°dn√© nenalezeny*")
            
            with col2:
                st.markdown("**üè∑Ô∏è Kategorick√© promƒõnn√©** (skupiny)")
                cat_vars = [k for k, v in types.items() if v == "kategorick√°"]
                if cat_vars:
                    for var in cat_vars:
                        st.markdown(f"- **{var}** ¬∑ {descriptions[var]}")
                else:
                    st.markdown("*≈Ω√°dn√© nenalezeny*")
            
            # Kontrola kvality dat
            st.markdown("### ü©∫ Kontrola kvality dat:")
            issues = []
            
            missing_total = df.isnull().sum().sum()
            if missing_total > 0:
                issues.append(f"‚ö†Ô∏è Celkem {missing_total} chybƒõj√≠c√≠ch hodnot")
            
            duplicates = df.duplicated().sum()
            if duplicates > 0:
                issues.append(f"‚ö†Ô∏è {duplicates} duplicitn√≠ch ≈ô√°dk≈Ø")
            
            if issues:
                st.markdown('<div class="warning-box">', unsafe_allow_html=True)
                for issue in issues:
                    st.markdown(issue)
                st.markdown("üí° **Tip:** To je OK, appka s t√≠m um√≠ pracovat. Chybƒõj√≠c√≠ hodnoty vy≈ôad√≠m z anal√Ωzy.")
                st.markdown('</div>', unsafe_allow_html=True)
            else:
                st.markdown('<div class="success-box">', unsafe_allow_html=True)
                st.markdown("‚úÖ Data vypadaj√≠ skvƒõle! ≈Ω√°dn√© chybƒõj√≠c√≠ hodnoty ani duplicity.")
                st.markdown('</div>', unsafe_allow_html=True)
            
            if st.button("‚û°Ô∏è Pokraƒçovat na Krok 2", use_container_width=True):
                st.session_state.step = 2
                st.rerun()
        
        except Exception as e:
            st.error(f"‚ùå Nepoda≈ôilo se naƒç√≠st soubor: {e}")
    
    st.markdown('</div>', unsafe_allow_html=True)

# ========================================
# KROK 2: V√ùZKUMN√ù C√çL
# ========================================

elif st.session_state.step == 2:
    df = st.session_state.df
    types, _ = detect_var_types(df)
    
    st.markdown('<div class="step-card">', unsafe_allow_html=True)
    st.markdown("## üéØ Krok 2: Co chce≈° zjistit?")
    st.markdown('<div class="chat-bubble">', unsafe_allow_html=True)
    st.markdown("**Ahoj! ≈ò√≠k√°m si, co tƒõ zaj√≠m√° z tƒõch dat?** Vyber, co nejl√©pe odpov√≠d√° tv√©mu v√Ωzkumu:")
    st.markdown('</div>', unsafe_allow_html=True)
    
    goal = st.radio(
        "M≈Øj v√Ωzkumn√Ω c√≠l:",
        [
            "üîó Chci zjistit, jestli spolu dvƒõ vƒõci souvis√≠ (korelace/vztah)",
            "‚öñÔ∏è Chci porovnat skupiny (jsou mezi nimi rozd√≠ly?)",
            "üìã Chci popsat sv√° data (pr≈Ømƒõry, ƒçetnosti)",
        ],
        label_visibility="collapsed"
    )
    
    if "souvis√≠" in goal:
        st.session_state.research_goal = "vztah"
        st.markdown('<div class="info-box">', unsafe_allow_html=True)
        st.markdown("**Perfektn√≠ volba!** üîó Budu hledat, jak silnƒõ spolu promƒõnn√© souvis√≠.")
        st.markdown("**P≈ô√≠klad:** *Souvis√≠ poƒçet hodin studia se zn√°mkami? Souvis√≠ v√Ω≈°ka s v√°hou?*")
        st.markdown('</div>', unsafe_allow_html=True)
    elif "porovnat" in goal:
        st.session_state.research_goal = "porovn√°n√≠"
        st.markdown('<div class="info-box">', unsafe_allow_html=True)
        st.markdown("**Skvƒõl√©!** ‚öñÔ∏è Zjist√≠m, jestli se skupiny statisticky li≈°√≠.")
        st.markdown("**P≈ô√≠klad:** *Maj√≠ mu≈æi a ≈æeny jin√© platy? Li≈°√≠ se zn√°mky mezi obory?*")
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.session_state.research_goal = "popis"
        st.markdown('<div class="info-box">', unsafe_allow_html=True)
        st.markdown("**V√Ωbornƒõ!** üìã P≈ôiprav√≠m p≈ôehledn√© statistiky tv√Ωch dat.")
        st.markdown("**P≈ô√≠klad:** *Jak√Ω je pr≈Ømƒõrn√Ω vƒõk? Kolik lid√≠ vybralo ka≈ædou odpovƒõƒè?*")
        st.markdown('</div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([1, 1])
    with col1:
        if st.button("‚¨ÖÔ∏è Zpƒõt na data", use_container_width=True):
            st.session_state.step = 1
            st.rerun()
    with col2:
        if st.button("‚û°Ô∏è Uka≈æ mi doporuƒçen√≠", use_container_width=True):
            recommendations = recommend_analysis(df, types, st.session_state.research_goal)
            st.session_state.recommended_analysis = recommendations
            st.session_state.step = 3
            st.rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

# ========================================
# KROK 3: DOPORUƒåEN√ç A ANAL√ùZA
# ========================================

elif st.session_state.step == 3:
    df = st.session_state.df
    types, _ = detect_var_types(df)
    recommendations = st.session_state.recommended_analysis
    
    st.markdown('<div class="step-card">', unsafe_allow_html=True)
    st.markdown("## üéì Krok 3: Doporuƒçen√≠ a anal√Ωza")
    
    st.markdown('<div class="chat-bubble">', unsafe_allow_html=True)
    st.markdown(f"**Na z√°kladƒõ tv√Ωch dat a c√≠le '{st.session_state.research_goal}' ti doporuƒçuji tyto anal√Ωzy:**")
    st.markdown('</div>', unsafe_allow_html=True)
    
    # Zobrazen√≠ doporuƒçen√≠
    for i, rec in enumerate(recommendations):
        with st.expander(f"{rec['icon']} **{rec['name']}** ‚Äî {rec['reason']}", expanded=(i==0)):
            st.markdown(f"**Vhodn√© pro:** {rec['suitable_for']}")
            st.markdown(f"**P≈ô√≠klad pou≈æit√≠:** {rec['example']}")
            
            if rec['type'] and st.button(f"‚ú® Pou≈æ√≠t tuto anal√Ωzu", key=f"btn_{i}", use_container_width=True):
                st.session_state.selected_analysis = rec
                st.session_state.step = 4
                st.rerun()
    
    col1, col2 = st.columns([1, 1])
    with col1:
        if st.button("‚¨ÖÔ∏è Zpƒõt na c√≠l", use_container_width=True):
            st.session_state.step = 2
            st.rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

# ========================================
# KROK 4: PROVEDEN√ç ANAL√ùZY
# ========================================

elif st.session_state.step == 4:
    df = st.session_state.df
    types, _ = detect_var_types(df)
    analysis = st.session_state.selected_analysis
    
    st.markdown('<div class="step-card">', unsafe_allow_html=True)
    st.markdown(f"## {analysis['icon']} {analysis['name']}")
    
    result_text = ""
    fig = None
    table_data = None
    
    # KORELACE
    if analysis['type'] == 'correlation':
        st.markdown("### Vyber promƒõnn√© pro korelaci:")
        col1, col2, col3 = st.columns(3)
        with col1:
            x = st.selectbox("Promƒõnn√° X:", analysis['variables']['x'])
        with col2:
            y = st.selectbox("Promƒõnn√° Y:", [v for v in analysis['variables']['y'] if v != x])
        with col3:
            method = st.radio("Metoda:", ["Pearson", "Spearman"])
        
        warnings, tips = check_assumptions(df, 'correlation', x, y)
        
        if warnings:
            st.markdown('<div class="warning-box">', unsafe_allow_html=True)
            for w in warnings:
                st.markdown(w)
            st.markdown('</div>', unsafe_allow_html=True)
        
        if tips:
            st.markdown('<div class="success-box">', unsafe_allow_html=True)
            for t in tips:
                st.markdown(t)
            st.markdown('</div>', unsafe_allow_html=True)
        
        if st.button("üöÄ Spustit anal√Ωzu", use_container_width=True):
            sx = df[x].dropna()
            sy = df[y].dropna()
            common_idx = sx.index.intersection(sy.index)
            sx = sx[common_idx]
            sy = sy[common_idx]
            
            if method == "Pearson":
                r, p = stats.pearsonr(sx, sy)
            else:
                r, p = stats.spearmanr(sx, sy)
            
            # Interpretace
            strength = "velmi slab√Ω"
            if abs(r) >= 0.7:
                strength = "siln√Ω"
            elif abs(r) >= 0.5:
                strength = "st≈ôednƒõ siln√Ω"
            elif abs(r) >= 0.3:
                strength = "slab√Ω"
            
            direction = "pozitivn√≠" if r > 0 else "negativn√≠"
            significant = "**statisticky v√Ωznamn√Ω**" if p < 0.05 else "**nen√≠ statisticky v√Ωznamn√Ω**"
            
            result_text = f"""
### üìä V√Ωsledky korelaƒçn√≠ anal√Ωzy

**Metoda:** {method}ova korelace  
**Poƒçet pozorov√°n√≠:** {len(sx)}  
**Korelaƒçn√≠ koeficient (r):** {r:.3f}  
**P-hodnota:** {p:.4f}  

### üí° Co to znamen√° pro tvou pr√°ci:

Mezi promƒõnn√Ωmi "{x}" a "{y}" byl nalezen **{strength} {direction} vztah** (r = {r:.3f}).  
Tento vztah je {significant} (p = {p:.4f}).

**Pro z√°vƒõreƒçnou pr√°ci m≈Ø≈æe≈° napsat:**  
"Byla provedena {method}ova korelaƒçn√≠ anal√Ωza pro zji≈°tƒõn√≠ vztahu mezi {x} a {y} (n = {len(sx)}). 
V√Ωsledky uk√°zaly {strength} {direction} vztah (r = {r:.3f}, p = {p:.4f}), 
kter√Ω {"je" if p < 0.05 else "nen√≠"} statisticky v√Ωznamn√Ω na hladinƒõ Œ± = 0,05."
            """
            
            # Graf
            fig = px.scatter(df, x=x, y=y, trendline="ols", 
                           title=f"Rozptylov√Ω graf: {x} vs {y}",
                           labels={x: x, y: y})
            fig.update_layout(
                font=dict(size=14),
                plot_bgcolor='white',
                paper_bgcolor='white',
                title_font_size=18
            )
            
            # Tabulka
            table_data = pd.DataFrame({
                'Metrika': ['Korelaƒçn√≠ koeficient (r)', 'P-hodnota', 'Poƒçet pozorov√°n√≠', 'S√≠la vztahu'],
                'Hodnota': [f"{r:.3f}", f"{p:.4f}", str(len(sx)), strength]
            })
            
            st.markdown(result_text)
            st.plotly_chart(fig, use_container_width=True)
            st.markdown("### üìã Tabulka v√Ωsledk≈Ø (ready for copy-paste)")
            st.dataframe(table_data, use_container_width=True)
    
    # T-TEST
    elif analysis['type'] == 'ttest':
        st.markdown("### Vyber promƒõnn√© pro t-test:")
        col1, col2 = st.columns(2)
        with col1:
            group = st.selectbox("Skupinov√° promƒõnn√° (2 kategorie):", analysis['variables']['group'])
        with col2:
            outcome = st.selectbox("Mƒõ≈ôen√° promƒõnn√° (ƒç√≠slo):", analysis['variables']['outcome'])
        
        warnings, tips = check_assumptions(df, 'ttest', group, outcome)
        
        if warnings:
            st.markdown('<div class="warning-box">', unsafe_allow_html=True)
            for w in warnings:
                st.markdown(w)
            st.markdown('</div>', unsafe_allow_html=True)
        
        if tips:
            st.markdown('<div class="success-box">', unsafe_allow_html=True)
            for t in tips:
                st.markdown(t)
            st.markdown('</div>', unsafe_allow_html=True)
        
        if st.button("üöÄ Spustit anal√Ωzu", use_container_width=True):
            tmp = df[[group, outcome]].dropna()
            groups = tmp[group].unique()
            
            g1 = tmp[tmp[group] == groups[0]][outcome]
            g2 = tmp[tmp[group] == groups[1]][outcome]
            
            t, p = stats.ttest_ind(g1, g2)
            
            # Cohen's d
            n1, n2 = len(g1), len(g2)
            s1, s2 = np.var(g1, ddof=1), np.var(g2, ddof=1)
            sp = np.sqrt(((n1-1)*s1 + (n2-1)*s2) / (n1+n2-2))
            d = (np.mean(g1) - np.mean(g2)) / sp if sp != 0 else 0
            
            effect_size = "mal√Ω"
            if abs(d) >= 0.8:
                effect_size = "velk√Ω"
            elif abs(d) >= 0.5:
                effect_size = "st≈ôedn√≠"
            
            significant = "**statisticky v√Ωznamn√Ω**" if p < 0.05 else "**nen√≠ statisticky v√Ωznamn√Ω**"
            
            result_text = f"""
### üìä V√Ωsledky t-testu

**Porovn√°n√≠:** {groups[0]} vs {groups[1]}  
**Skupina 1 ({groups[0]}):** pr≈Ømƒõr = {np.mean(g1):.2f}, n = {n1}  
**Skupina 2 ({groups[1]}):** pr≈Ømƒõr = {np.mean(g2):.2f}, n = {n2}  
**T-statistika:** {t:.3f}  
**P-hodnota:** {p:.4f}  
**Cohenovo d:** {d:.3f} ({effect_size} efekt)

### üí° Co to znamen√° pro tvou pr√°ci:

Rozd√≠l v pr≈Ømƒõrech promƒõnn√© "{outcome}" mezi skupinami "{groups[0]}" a "{groups[1]}" je {significant} (p = {p:.4f}).
Velikost efektu je {effect_size} (d = {d:.3f}).

**Pro z√°vƒõreƒçnou pr√°ci m≈Ø≈æe≈° napsat:**  
"Pro porovn√°n√≠ pr≈Ømƒõr≈Ø promƒõnn√© {outcome} mezi skupinami {group} byl pou≈æit dvouv√Ωbƒõrov√Ω t-test (n‚ÇÅ = {n1}, n‚ÇÇ = {n2}). 
Pr≈Ømƒõr skupiny {groups[0]} byl {np.mean(g1):.2f}, pr≈Ømƒõr skupiny {groups[1]} byl {np.mean(g2):.2f}. 
Rozd√≠l {"je" if p < 0.05 else "nen√≠"} statisticky v√Ωznamn√Ω (t = {t:.2f}, p = {p:.4f}, d = {d:.2f})."
            """
            
            # Graf
            plot_df = pd.DataFrame({
                group: list(g1.index.map(lambda x: groups[0])) + list(g2.index.map(lambda x: groups[1])),
                outcome: list(g1) + list(g2)
            })
            fig = px.box(plot_df, x=group, y=outcome, title=f"Porovn√°n√≠: {outcome} podle {group}",
                        color=group)
            fig.update_layout(showlegend=False, font=dict(size=14))
            
            # Tabulka
            table_data = pd.DataFrame({
                'Skupina': [groups[0], groups[1]],
                'Pr≈Ømƒõr': [f"{np.mean(g1):.2f}", f"{np.mean(g2):.2f}"],
                'Smƒõrodatn√° odchylka': [f"{np.std(g1, ddof=1):.2f}", f"{np.std(g2, ddof=1):.2f}"],
                'n': [n1, n2]
            })
            
            st.markdown(result_text)
            st.plotly_chart(fig, use_container_width=True)
            st.markdown("### üìã Tabulka deskriptivn√≠ch statistik")
            st.dataframe(table_data, use_container_width=True)
    
    # ANOVA
    elif analysis['type'] == 'anova':
        st.markdown("### Vyber promƒõnn√© pro ANOVA:")
        col1, col2 = st.columns(2)
        with col1:
            group = st.selectbox("Skupinov√° promƒõnn√° (3+ kategori√≠):", analysis['variables']['group'])
        with col2:
            outcome = st.selectbox("Mƒõ≈ôen√° promƒõnn√° (ƒç√≠slo):", analysis['variables']['outcome'])
        
        if st.button("üöÄ Spustit anal√Ωzu", use_container_width=True):
            tmp = df[[group, outcome]].dropna()
            formula = f"{outcome} ~ C({group})"
            model = ols(formula, data=tmp).fit()
            anova_table = sm.stats.anova_lm(model, typ=2)
            
            F = anova_table.loc[f'C({group})', 'F']
            p = anova_table.loc[f'C({group})', 'PR(>F)']
            
            # Eta squared
            ss_effect = anova_table.loc[f'C({group})', 'sum_sq']
            ss_resid = anova_table.loc['Residual', 'sum_sq']
            eta2 = ss_effect / (ss_effect + ss_resid)
            
            effect_size = "mal√Ω"
            if eta2 >= 0.14:
                effect_size = "velk√Ω"
            elif eta2 >= 0.06:
                effect_size = "st≈ôedn√≠"
            
            significant = "**statisticky v√Ωznamn√Ω**" if p < 0.05 else "**nen√≠ statisticky v√Ωznamn√Ω**"
            
            # Pr≈Ømƒõry skupin
            group_means = tmp.groupby(group)[outcome].agg(['mean', 'std', 'count'])
            
            result_text = f"""
### üìä V√Ωsledky ANOVA

**F-statistika:** {F:.3f}  
**P-hodnota:** {p:.4f}  
**Eta-squared (Œ∑¬≤):** {eta2:.3f} ({effect_size} efekt)  
**Poƒçet skupin:** {tmp[group].nunique()}  
**Celkov√Ω poƒçet pozorov√°n√≠:** {len(tmp)}

### üí° Co to znamen√° pro tvou pr√°ci:

Rozd√≠ly v pr≈Ømƒõrech promƒõnn√© "{outcome}" mezi skupinami "{group}" jsou {significant} (p = {p:.4f}).
Velikost efektu je {effect_size} (Œ∑¬≤ = {eta2:.3f}).

**Pro z√°vƒõreƒçnou pr√°ci m≈Ø≈æe≈° napsat:**  
"Pro porovn√°n√≠ pr≈Ømƒõr≈Ø promƒõnn√© {outcome} mezi skupinami {group} byla pou≈æita jednofaktorov√° ANOVA (n = {len(tmp)}). 
Rozd√≠ly mezi skupinami {"jsou" if p < 0.05 else "nejsou"} statisticky v√Ωznamn√© (F = {F:.2f}, p = {p:.4f}, Œ∑¬≤ = {eta2:.2f})."
            """
            
            # Graf
            fig = px.box(tmp, x=group, y=outcome, title=f"Porovn√°n√≠: {outcome} podle {group}",
                        color=group)
            fig.update_layout(showlegend=False, font=dict(size=14))
            
            # Tabulka
            table_data = group_means.reset_index()
            table_data.columns = ['Skupina', 'Pr≈Ømƒõr', 'Smƒõrodatn√° odchylka', 'n']
            table_data['Pr≈Ømƒõr'] = table_data['Pr≈Ømƒõr'].round(2)
            table_data['Smƒõrodatn√° odchylka'] = table_data['Smƒõrodatn√° odchylka'].round(2)
            
            st.markdown(result_text)
            st.plotly_chart(fig, use_container_width=True)
            st.markdown("### üìã Tabulka deskriptivn√≠ch statistik")
            st.dataframe(table_data, use_container_width=True)
    
    # CH√ç-KVADR√ÅT
    elif analysis['type'] == 'chi2':
        st.markdown("### Vyber promƒõnn√© pro ch√≠-kvadr√°t test:")
        col1, col2 = st.columns(2)
        with col1:
            var1 = st.selectbox("Promƒõnn√° 1:", analysis['variables']['var1'])
        with col2:
            var2 = st.selectbox("Promƒõnn√° 2:", [v for v in analysis['variables']['var2'] if v != var1])
        
        if st.button("üöÄ Spustit anal√Ωzu", use_container_width=True):
            tmp = df[[var1, var2]].dropna()
            ctab = pd.crosstab(tmp[var1], tmp[var2])
            chi2, p, dof, expected = stats.chi2_contingency(ctab)
            
            # Cram√©r's V
            n = ctab.sum().sum()
            r, c = ctab.shape
            v = np.sqrt(chi2 / (n * (min(r-1, c-1))))
            
            effect_size = "slab√°"
            if v >= 0.5:
                effect_size = "siln√°"
            elif v >= 0.3:
                effect_size = "st≈ôedn√≠"
            
            significant = "**statisticky v√Ωznamn√°**" if p < 0.05 else "**nen√≠ statisticky v√Ωznamn√°**"
            
            result_text = f"""
### üìä V√Ωsledky ch√≠-kvadr√°t testu

**Ch√≠-kvadr√°t statistika:** {chi2:.3f}  
**P-hodnota:** {p:.4f}  
**Stupnƒõ volnosti:** {dof}  
**Cram√©rovo V:** {v:.3f} ({effect_size} asociace)  
**Poƒçet pozorov√°n√≠:** {n}

### üí° Co to znamen√° pro tvou pr√°ci:

Asociace mezi promƒõnn√Ωmi "{var1}" a "{var2}" je {significant} (p = {p:.4f}).
S√≠la asociace je {effect_size} (V = {v:.3f}).

**Pro z√°vƒõreƒçnou pr√°ci m≈Ø≈æe≈° napsat:**  
"Pro testov√°n√≠ nez√°vislosti mezi promƒõnn√Ωmi {var1} a {var2} byl pou≈æit ch√≠-kvadr√°t test (n = {n}). 
Asociace mezi promƒõnn√Ωmi {"je" if p < 0.05 else "nen√≠"} statisticky v√Ωznamn√° (œá¬≤ = {chi2:.2f}, df = {dof}, p = {p:.4f}, V = {v:.2f})."
            """
            
            # Graf
            fig = px.bar(ctab.reset_index().melt(id_vars=var1), 
                        x=var1, y='value', color=var2, barmode='group',
                        title=f"Kontingenƒçn√≠ tabulka: {var1} √ó {var2}")
            fig.update_layout(font=dict(size=14))
            
            st.markdown(result_text)
            st.plotly_chart(fig, use_container_width=True)
            st.markdown("### üìã Kontingenƒçn√≠ tabulka")
            st.dataframe(ctab, use_container_width=True)
    
    # LINE√ÅRN√ç REGRESE
    elif analysis['type'] == 'regression':
        st.markdown("### Vyber promƒõnn√© pro regresi:")
        col1, col2 = st.columns(2)
        with col1:
            x_var = st.selectbox("Nez√°visl√° promƒõnn√° (X, prediktor):", analysis['variables']['x'])
        with col2:
            y_var = st.selectbox("Z√°visl√° promƒõnn√° (Y, v√Ωstup):", [v for v in analysis['variables']['y'] if v != x_var])
        
        if st.button("üöÄ Spustit anal√Ωzu", use_container_width=True):
            sx = df[x_var].dropna()
            sy = df[y_var].dropna()
            common_idx = sx.index.intersection(sy.index)
            sx = sx[common_idx]
            sy = sy[common_idx]
            
            X = sm.add_constant(sx)
            model = sm.OLS(sy, X).fit()
            
            r2 = model.rsquared
            adj_r2 = model.rsquared_adj
            f_stat = model.fvalue
            f_p = model.f_pvalue
            coef = model.params[x_var]
            coef_p = model.pvalues[x_var]
            intercept = model.params['const']
            
            significant = "**statisticky v√Ωznamn√Ω**" if f_p < 0.05 else "**nen√≠ statisticky v√Ωznamn√Ω**"
            
            result_text = f"""
### üìä V√Ωsledky line√°rn√≠ regrese

**Model:** {y_var} = {intercept:.3f} + {coef:.3f} √ó {x_var}  
**R¬≤ (procento vysvƒõtlen√© variability):** {r2:.3f} ({r2*100:.1f}%)  
**Adjustovan√© R¬≤:** {adj_r2:.3f}  
**F-statistika:** {f_stat:.3f}, p = {f_p:.4f}  
**Koeficient pro {x_var}:** {coef:.3f} (p = {coef_p:.4f})  
**Poƒçet pozorov√°n√≠:** {len(sx)}

### üí° Co to znamen√° pro tvou pr√°ci:

Model je {significant} (p = {f_p:.4f}).  
Promƒõnn√° "{x_var}" vysvƒõtluje {r2*100:.1f}% variability promƒõnn√© "{y_var}".  
P≈ôi zv√Ω≈°en√≠ {x_var} o 1 jednotku se {y_var} {"zv√Ω≈°√≠" if coef > 0 else "sn√≠≈æ√≠"} pr≈Ømƒõrnƒõ o {abs(coef):.3f}.

**Pro z√°vƒõreƒçnou pr√°ci m≈Ø≈æe≈° napsat:**  
"Byla provedena jednoduch√° line√°rn√≠ regrese pro predikci {y_var} na z√°kladƒõ {x_var} (n = {len(sx)}). 
Model {"je" if f_p < 0.05 else "nen√≠"} statisticky v√Ωznamn√Ω (F = {f_stat:.2f}, p = {f_p:.4f}) 
a vysvƒõtluje {r2*100:.1f}% variability z√°visl√© promƒõnn√© (R¬≤ = {r2:.3f})."
            """
            
            # Graf
            fig = px.scatter(df, x=x_var, y=y_var, trendline="ols",
                           title=f"Line√°rn√≠ regrese: {y_var} ~ {x_var}")
            fig.update_layout(font=dict(size=14))
            
            # Tabulka
            table_data = pd.DataFrame({
                'Metrika': ['R¬≤', 'Adjustovan√© R¬≤', 'F-statistika', 'P-hodnota', 'Koeficient', 'Intercept'],
                'Hodnota': [f"{r2:.3f}", f"{adj_r2:.3f}", f"{f_stat:.2f}", f"{f_p:.4f}", f"{coef:.3f}", f"{intercept:.3f}"]
            })
            
            st.markdown(result_text)
            st.plotly_chart(fig, use_container_width=True)
            st.markdown("### üìã Tabulka v√Ωsledk≈Ø")
            st.dataframe(table_data, use_container_width=True)
    
    # DESKRIPTIVN√ç STATISTIKA
    elif analysis['type'] == 'descriptive':
        st.markdown("### Vyber promƒõnn√© pro popis:")
        selected_cols = st.multiselect("Kter√© promƒõnn√© chce≈° popsat?", df.columns.tolist(), default=df.columns.tolist()[:3])
        
        if st.button("üöÄ Zobrazit statistiky", use_container_width=True):
            num_cols = [c for c in selected_cols if pd.api.types.is_numeric_dtype(df[c])]
            cat_cols = [c for c in selected_cols if not pd.api.types.is_numeric_dtype(df[c])]
            
            st.markdown("### üìä Numerick√© promƒõnn√©")
            if num_cols:
                desc = df[num_cols].describe().T
                desc['chybƒõj√≠c√≠'] = df[num_cols].isnull().sum()
                st.dataframe(desc.round(2), use_container_width=True)
                
                for col in num_cols:
                    fig = px.histogram(df, x=col, title=f"Distribuce: {col}")
                    st.plotly_chart(fig, use_container_width=True)
            
            st.markdown("### üè∑Ô∏è Kategorick√© promƒõnn√©")
            if cat_cols:
                for col in cat_cols:
                    freq = df[col].value_counts()
                    st.markdown(f"**{col}:**")
                    st.dataframe(freq, use_container_width=True)
                    
                    fig = px.bar(x=freq.index, y=freq.values, title=f"ƒåetnosti: {col}",
                               labels={'x': col, 'y': 'Poƒçet'})
                    st.plotly_chart(fig, use_container_width=True)
    
    # EXPORT
    if result_text:
        st.markdown("---")
        st.markdown("### üíæ Export v√Ωsledk≈Ø")
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("üìÑ St√°hnout jako Word", use_container_width=True):
                doc = Document()
                
                # Titulek
                title = doc.add_heading(f'QuantBuddy ‚Äî {analysis["name"]}', 0)
                title.alignment = WD_ALIGN_PARAGRAPH.CENTER
                
                # Metadata
                doc.add_paragraph(f"Datum: {datetime.now().strftime('%d.%m.%Y %H:%M')}")
                doc.add_paragraph(f"Poƒçet pozorov√°n√≠: {len(df)}")
                
                # V√Ωsledky
                doc.add_heading('V√Ωsledky anal√Ωzy', level=1)
                doc.add_paragraph(result_text.replace('###', '').replace('**', ''))
                
                # Graf
                if fig:
                    doc.add_heading('Vizualizace', level=1)
                    img_bytes = fig.to_image(format="png", width=1200, height=800)
                    with tempfile.NamedTemporaryFile(suffix=".png", delete=False) as tmp:
                        tmp.write(img_bytes)
                        tmp.flush()
                        doc.add_picture(tmp.name, width=Inches(6))
                
                # Ulo≈æen√≠
                bio = io.BytesIO()
                doc.save(bio)
                bio.seek(0)
                
                st.download_button(
                    label="‚¨áÔ∏è St√°hnout Word dokument",
                    data=bio,
                    file_name=f"quantbuddy_{analysis['type']}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.docx",
                    mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    use_container_width=True
                )
        
        with col2:
            if st.button("üîÑ Spustit novou anal√Ωzu", use_container_width=True):
                st.session_state.step = 2
                st.rerun()
    
    if st.button("‚¨ÖÔ∏è Zpƒõt na doporuƒçen√≠", use_container_width=True):
        st.session_state.step = 3
        st.rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

# ========================================
# FOOTER
# ========================================

st.markdown("---")
st.markdown("""
<div style="text-align: center; color: gray; font-size: 0.9rem; padding: 2rem 0;">
    <p>ü§ñ <strong>QuantBuddy AI v3.0</strong></p>
    <p>Tv≈Øj inteligentn√≠ asistent pro kvantitativn√≠ v√Ωzkum</p>
    <p style="font-size: 0.8rem; margin-top: 1rem;">
        üí° <em>Tip: V√Ωsledky jsou p≈ôipraven√© pro pou≈æit√≠ v z√°vƒõreƒçn√© pr√°ci, 
        ale v≈ædy je dobr√© konzultovat s vedouc√≠m!</em>
    </p>
</div>
""", unsafe_allow_html=True)
